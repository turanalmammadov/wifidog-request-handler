# Database Schema Documentation

This directory contains database schema and setup files for the Wifidog authentication system.

## üìä Database Schema

### Tables

#### `users`
Stores user account information for WiFi authentication.

**Columns:**
- `id` - Primary key
- `username` - Unique username
- `password` - Hashed password (use bcrypt)
- `email` - User email address
- `is_active` - Account status
- `created_at` - Account creation timestamp
- `updated_at` - Last modification timestamp
- `last_login` - Last successful login

**Indexes:**
- `idx_username` - Fast username lookups
- `idx_email` - Email-based queries
- `idx_active` - Filter active users

#### `sessions`
Tracks active and historical user sessions.

**Columns:**
- `id` - Primary key
- `token` - Unique session token (generated by Wifidog)
- `user_id` - Foreign key to users table
- `mac_address` - Client MAC address
- `ip_address` - Client IP address
- `gateway_id` - Router/gateway identifier
- `incoming_bytes` - Download traffic
- `outgoing_bytes` - Upload traffic
- `session_start` - When session began
- `last_activity` - Last activity timestamp
- `session_end` - When session ended (NULL if active)
- `is_active` - Session status

**Indexes:**
- `idx_token` - Fast token lookups (critical for auth)
- `idx_user_id` - User session history
- `idx_mac` - MAC address tracking
- `idx_active` - Active session filtering

#### `gateways`
Tracks Wifidog router/gateway nodes in the network.

**Columns:**
- `id` - Primary key
- `gateway_id` - Unique gateway identifier
- `name` - Human-readable gateway name
- `location` - Physical location
- `ip_address` - Gateway IP
- `last_ping` - Last ping received
- `is_online` - Online status

#### `auth_logs`
Audit trail for all authentication attempts and actions.

**Columns:**
- `id` - Primary key
- `user_id` - User involved (nullable)
- `session_id` - Session involved (nullable)
- `action` - Action type (login, logout, auth, etc.)
- `ip_address` - Client IP
- `mac_address` - Client MAC
- `gateway_id` - Gateway ID
- `result` - Success/failure
- `message` - Additional details
- `created_at` - Timestamp

#### `bandwidth_stats`
Hourly bandwidth usage aggregation for analytics.

**Columns:**
- `id` - Primary key
- `user_id` - User reference
- `gateway_id` - Gateway reference
- `hour_timestamp` - Hour bucket
- `incoming_bytes` - Download traffic
- `outgoing_bytes` - Upload traffic
- `total_bytes` - Generated column (sum)

### Views

#### `active_sessions`
Quick access to currently active sessions with user info.

#### `user_stats`
Aggregated statistics per user (sessions, bandwidth, last seen).

## üöÄ Setup Instructions

### MySQL Setup

```bash
# Create database
mysql -u root -p
CREATE DATABASE wifidog_auth;
USE wifidog_auth;

# Import schema
source database/schema.sql;

# Verify tables
SHOW TABLES;
```

### PostgreSQL Setup

```bash
# Create database
createdb wifidog_auth

# Import schema (may need minor adjustments)
psql wifidog_auth < database/schema.sql
```

## üîí Security Best Practices

### Password Hashing
Always use strong password hashing:

```php
// Use PHP password_hash()
$hashed = password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);

// Verify
if (password_verify($input_password, $stored_hash)) {
    // Valid password
}
```

### Token Generation
Generate cryptographically secure session tokens:

```php
$token = bin2hex(random_bytes(32)); // 64-char hex string
```

### Database Credentials
- Never commit database credentials to git
- Use environment variables or config files
- Keep config files in .gitignore
- Use different credentials per environment

## üìä Performance Optimization

### Indexes
All critical columns are indexed:
- User lookups: `username`, `email`
- Session queries: `token`, `user_id`, `mac_address`
- Active filtering: `is_active` columns

### Cleanup Queries

```sql
-- Delete old inactive sessions (older than 30 days)
DELETE FROM sessions 
WHERE is_active = FALSE 
AND session_end < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- Archive old auth logs
-- (Implement based on your retention policy)
```

## üß™ Testing

### Sample Queries

```sql
-- Get active users count
SELECT COUNT(DISTINCT user_id) FROM active_sessions;

-- User bandwidth usage
SELECT username, total_incoming, total_outgoing 
FROM user_stats 
ORDER BY (total_incoming + total_outgoing) DESC 
LIMIT 10;

-- Gateway status
SELECT gateway_id, name, is_online, last_ping 
FROM gateways 
ORDER BY last_ping DESC;

-- Recent auth attempts
SELECT * FROM auth_logs 
ORDER BY created_at DESC 
LIMIT 50;
```

## üìà Migration Strategy

If migrating from existing system:

1. Backup existing data
2. Create new tables with schema.sql
3. Migrate data using INSERT SELECT statements
4. Verify data integrity
5. Update application connection strings
6. Test thoroughly before production

## üîß Maintenance

### Regular Tasks

- Monitor active sessions
- Clean up expired sessions
- Archive old logs
- Optimize indexes
- Backup database regularly

### Monitoring Queries

```sql
-- Active sessions count
SELECT COUNT(*) FROM sessions WHERE is_active = TRUE;

-- Online gateways
SELECT COUNT(*) FROM gateways WHERE is_online = TRUE;

-- Recent authentications
SELECT COUNT(*) FROM auth_logs 
WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

## üìù Schema Version

**Version:** 1.0  
**Last Updated:** February 2026  
**Compatible:** MySQL 5.7+, PostgreSQL 9.6+

---

For questions or improvements, please open an issue or PR!
